<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ ç­è¨ˆç®—å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©å­—é«”ç‚º Interï¼Œç¢ºä¿æ•´é«”ç¾è§€ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F2F2F7; /* Appleé¢¨æ ¼æ·ºç°è‰²èƒŒæ™¯ */
            color: #1C1C1E; /* æ·±è‰²æ–‡å­—ï¼Œé«˜å°æ¯” */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* èª¿æ•´ç‚ºå¾é ‚éƒ¨é–‹å§‹ï¼Œé¿å…å…§å®¹éé•·æ™‚è¢«æˆªæ–· */
            min-height: 100vh; /* ç¢ºä¿å…§å®¹è‡³å°‘ä½”æ»¿æ•´å€‹è¦–çª—é«˜åº¦ */
            padding: 20px; /* å¢åŠ æ•´é«”å…§é‚Šè· */
            box-sizing: border-box; /* åŒ…å«å…§é‚Šè·å’Œé‚Šæ¡†åœ¨å…ƒç´ ç¸½å¯¬é«˜å…§ */
        }
        .container {
            background-color: #FFFFFF; /* ç´”ç™½è‰²å®¹å™¨èƒŒæ™¯ */
            border-radius: 12px; /* æŸ”å’Œåœ“è§’ */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03); /* ç´°è†©é™°å½± */
            padding: 30px;
            max-width: 500px; /* æœ€å¤§å¯¬åº¦ */
            width: 100%; /* éŸ¿æ‡‰å¼å¯¬åº¦ */
            margin-top: 20px; /* é ‚éƒ¨é–“è· */
            border: 1px solid #E5E5EA; /* éå¸¸æ·ºçš„é‚Šæ¡† */
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #8E8E93; /* ä¸­ç°è‰²æ–‡å­—ï¼ŒæŸ”å’Œ */
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            background-color: #FFFFFF; /* è¼¸å…¥æ¡†ç™½è‰²èƒŒæ™¯ */
            border: 1px solid #E5E5EA; /* æ·ºç°è‰²é‚Šæ¡† */
            border-radius: 8px; /* åœ“è§’ */
            font-size: 16px;
            color: #1C1C1E; /* è¼¸å…¥æ¡†æ–‡å­—é¡è‰² */
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸å¢åŠ å¯¬åº¦ */
        }
        /* é‡å°æ—¥æœŸè¼¸å…¥æ¡†çš„æ–‡å­—é¡è‰²å’ŒèƒŒæ™¯è‰²é€²è¡Œå„ªåŒ– */
        .input-group input[type="date"], .entry-item input[type="date"] {
            background-color: #FFFFFF !important; /* å¼·åˆ¶ç™½è‰²èƒŒæ™¯ */
            color: #1C1C1E !important; /* å¼·åˆ¶æ·±è‰²æ–‡å­— */
            opacity: 1 !important; /* ç¢ºä¿æ²’æœ‰é€æ˜åº¦å•é¡Œ */
        }
        /* é‡å°æ—¥æœŸè¼¸å…¥æ¡†çš„ placeholder æ–‡å­—é¡è‰² */
        .input-group input[type="date"]::placeholder, .entry-item input[type="date"]::placeholder {
            color: #C7C7CC !important; /* æ·ºç°è‰²ï¼Œç¢ºä¿å¯è¦‹ */
            opacity: 1 !important;
        }

        /* é‡å°ä¸‹æ‹‰é¸å–®åŠå…¶é¸é …çš„æ–‡å­—é¡è‰²å’ŒèƒŒæ™¯è‰²é€²è¡Œå„ªåŒ– */
        .input-group select, .entry-item select {
            color: #1C1C1E; /* æ·±è‰²æ–‡å­—ï¼Œé«˜å°æ¯” */
            background-color: #FFFFFF; /* è¨­å®šç‚ºç™½è‰²èƒŒæ™¯ */
        }
        .input-group select option, .entry-item select option {
            background-color: #FFFFFF; /* é¸é …èƒŒæ™¯è‰²èˆ‡å®¹å™¨ä¸€è‡´ */
            color: #1C1C1E; /* é¸é …æ–‡å­—é¡è‰² */
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #007AFF; /* ç„¦é»æ™‚çš„ Apple è—è‰²é‚Šæ¡† */
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); /* ç„¦é»æ™‚çš„æŸ”å’Œå…‰æšˆæ•ˆæœ */
        }
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            text-align: center;
            display: inline-block;
            width: auto; /* è®“æŒ‰éˆ•å¯¬åº¦è‡ªé©æ‡‰ */
        }
        .btn-primary {
            background-color: #007AFF; /* Apple è—è‰² */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 122, 255, 0.2);
        }
        .btn-primary:hover {
            background-color: #005BBF; /* ç¨æ·±çš„è—è‰² */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 122, 255, 0.3);
        }
        .btn-secondary {
            background-color: #E5E5EA; /* æ·ºç°è‰² */
            color: #1C1C1E; /* æ·±è‰²æ–‡å­— */
            border: 1px solid #D1D1D6; /* ç¨æ·±çš„æ·ºç°è‰²é‚Šæ¡† */
        }
        .btn-secondary:hover {
            background-color: #D1D1D6; /* ç¨æ·±çš„æ·ºç°è‰² */
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #FF3B30; /* Apple ç´…è‰² */
            color: white;
        }
        .btn-danger:hover {
            background-color: #CC0000; /* ç¨æ·±çš„ç´…è‰² */
            transform: translateY(-1px);
        }
        .btn-outline {
            background-color: transparent;
            color: #007AFF; /* Apple è—è‰² */
            border: 1px solid #007AFF;
        }
        .btn-outline:hover {
            background-color: rgba(0, 122, 255, 0.05); /* æ·ºè—è‰²é€æ˜èƒŒæ™¯ */
            transform: translateY(-1px);
        }
        .entry-item { /* çµ±ä¸€åŠ ç­å’Œè«‹å‡æ¢ç›®çš„æ¨£å¼ */
            display: flex;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            gap: 10px; /* å…ƒç´ é–“è· */
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #E5E5EA; /* æ·ºé‚Šæ¡† */
            border-radius: 10px;
            background-color: #FFFFFF; /* ç™½è‰²èƒŒæ™¯ */
            align-items: flex-end; /* åº•éƒ¨å°é½Š */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03); /* ç´°è†©é™°å½± */
        }
        .entry-item .flex-grow {
            flex-grow: 1; /* è®“è¼¸å…¥æ¡†ç›¡å¯èƒ½ä½”æ»¿ç©ºé–“ */
            min-width: 120px; /* æœ€å°å¯¬åº¦ */
        }
        .entry-item .remove-btn {
            flex-shrink: 0; /* ä¸ç¸®å° */
            margin-left: auto; /* æ¨åˆ°æœ€å³é‚Š */
        }
        .results-area {
            background-color: #EBF7FF; /* éå¸¸æ·ºçš„è—è‰²èƒŒæ™¯ */
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #B3D9FF; /* æ·ºè—è‰²é‚Šæ¡† */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .results-area h3 {
            font-size: 20px;
            font-weight: 700;
            color: #007AFF; /* Apple è—è‰² */
            margin-bottom: 15px;
        }
        .results-area p {
            font-size: 16px;
            color: #1C1C1E; /* æ·±è‰²æ–‡å­— */
            line-height: 1.6;
        }
        .results-area p strong {
            color: #005BBF; /* æ›´æ·±çš„è—è‰² */
        }
        .error-message {
            color: #FF3B30; /* Apple ç´…è‰² */
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        .flex-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center; /* æŒ‰éˆ•å±…ä¸­ */
            flex-wrap: wrap; /* å…è¨±æŒ‰éˆ•æ›è¡Œ */
        }
        hr {
            border-top: 1px solid #D1D1D6; /* æ·ºè‰²åˆ†éš”ç·šæ¨£å¼ */
        }
        /* æ–°å¢çš„ checkbox æ¨£å¼ */
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 20px; /* å¢å¤§é»æ“Šå€åŸŸ */
            height: 20px;
            accent-color: #007AFF; /* Apple è—è‰² */
            cursor: pointer;
        }
        .checkbox-group label {
            margin-bottom: 0; /* ç§»é™¤é è¨­ label çš„ä¸‹é‚Šè· */
            font-weight: 500;
            color: #1C1C1E;
        }
        /* å¥ä¿çœ·å±¬äººæ•¸è¼¸å…¥æ¡†çš„é¡¯ç¤º/éš±è— */
        .dependents-input-group {
            display: none; /* é è¨­éš±è— */
            margin-top: -10px; /* èª¿æ•´èˆ‡ä¸Šæ–¹ checkbox çš„é–“è· */
            margin-bottom: 20px;
        }
        .dependents-input-group.active {
            display: block; /* å•Ÿç”¨æ™‚é¡¯ç¤º */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">åŠ ç­è¨ˆç®—å™¨</h1>
        <p class="text-center text-gray-600 mb-8">
            è¨ˆç®—æ‚¨åœ¨ <span id="currentMonthDisplay"></span> çš„åŠ ç­è²»åŠç›¸é—œè£œåŠ©ã€‚
        </p>

        <!-- å…¬å¸åç¨±è¼¸å…¥ -->
        <div class="input-group">
            <label for="companyName">å…¬å¸åç¨±</label>
            <select id="companyName" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                <option value="éå»£é”">éå»£é”</option>
                <option value="å»£é”">å»£é”</option>
            </select>
            <p class="text-sm text-gray-500 mt-1">
                <small>åªæœ‰å…¬å¸åç¨±ç‚ºã€Œå»£é”ã€æ™‚ï¼Œæ‰è¨ˆç®—é¤è£œã€‚</small>
            </p>
        </div>

        <!-- æœˆè–ªè¼¸å…¥ -->
        <div class="input-group">
            <label for="monthlySalary">æœˆè–ª (å…ƒ)</label>
            <input type="number" id="monthlySalary" placeholder="è«‹è¼¸å…¥ç´”æ•¸å­—ï¼Œä¾‹å¦‚ï¼š30000" class="focus:ring-blue-500 focus:border-blue-500">
            <p id="salaryError" class="error-message hidden">è«‹è¼¸å…¥æœ‰æ•ˆçš„æœˆè–ªæ•¸å­—ã€‚</p>
        </div>

        <!-- å‹å¥ä¿æ‰£é™¤é¸é … -->
        <div class="checkbox-group">
            <input type="checkbox" id="deductInsuranceCheckbox">
            <label for="deductInsuranceCheckbox">æ˜¯å¦æ‰£é™¤å‹å¥ä¿è²»ï¼Ÿ</label>
        </div>

        <!-- å¥ä¿çœ·å±¬äººæ•¸è¼¸å…¥ (é è¨­éš±è—) -->
        <div class="input-group dependents-input-group" id="dependentsInputGroup">
            <label for="healthInsuranceDependents">å¥ä¿çœ·å±¬äººæ•¸</label>
            <input type="number" id="healthInsuranceDependents" value="0" min="0" class="focus:ring-blue-500 focus:border-blue-500">
            <p class="text-sm text-gray-500 mt-1">
                <small>è«‹è¼¸å…¥å¥ä¿åŠ ä¿çš„çœ·å±¬äººæ•¸ (ä¸å«æœ¬äºº)ã€‚</small>
                <br>
                <small class="text-red-400">**å‹å¥ä¿è²»ç‡èˆ‡ç´šè·ç‚ºå…§å»ºå›ºå®šè³‡æ–™ï¼Œå¯èƒ½ç„¡æ³•å³æ™‚åæ˜ æœ€æ–°å…¬å‘Šã€‚**</small>
            </p>
        </div>

        <!-- è¨ˆç®—æœˆä»½é¸æ“‡ -->
        <div class="input-group flex gap-4">
            <div class="flex-grow">
                <label for="calcYear">è¨ˆç®—å¹´ä»½</label>
                <select id="calcYear" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
            <div class="flex-grow">
                <label for="calcMonth">è¨ˆç®—æœˆä»½</label>
                <select id="calcMonth" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
        </div>

        <!-- æ¯æœˆç¸½å·¥ä½œå¤©æ•¸è¼¸å…¥ -->
        <div class="input-group">
            <label for="totalWorkingDays">æ¯æœˆç¸½å·¥ä½œå¤©æ•¸ (é¸å¡«)</label>
            <input type="number" id="totalWorkingDays" placeholder="ä¾‹å¦‚ï¼š22 (æ‰‹å‹•è¼¸å…¥å„ªå…ˆ)" class="focus:ring-blue-500 focus:border-blue-500">
            <p id="workingDaysError" class="error-message hidden">è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¸½å·¥ä½œå¤©æ•¸ã€‚</p>
            <p class="text-sm text-gray-500 mt-1">
                <small>è‹¥ä¸å¡«å¯«ï¼Œå°‡è‡ªå‹•è¨ˆç®—æ‰€é¸æœˆä»½æ‰£é™¤é€±å…­æ—¥åŠå…§å»ºåœ‹å®šå‡æ—¥å¾Œçš„å·¥ä½œå¤©æ•¸ã€‚</small>
                <br>
                <small class="text-red-400">**åœ‹å®šå‡æ—¥è³‡æ–™ç‚ºå…§å»ºå›ºå®šæ¸…å–®ï¼Œå¯èƒ½ç„¡æ³•å³æ™‚åæ˜ æœ€æ–°å…¬å‘Šã€‚è«‹å‹™å¿…æ ¸å°å¾Œæ‰‹å‹•èª¿æ•´ã€‚**</small>
            </p>
        </div>
        
        <h2 class="text-xl font-bold text-gray-700 mb-4 mt-8">è«‹å‡è¨˜éŒ„</h2>
        <div id="leaveRecordsContainer">
            <!-- è«‹å‡æ¢ç›®å°‡å‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->
        </div>
        <button id="addLeaveDayBtn" class="btn btn-outline w-full mb-6">
            + æ–°å¢è«‹å‡è¨˜éŒ„
        </button>

        <h2 class="text-xl font-bold text-gray-700 mb-4 mt-8">åŠ ç­è¨˜éŒ„</h2>
        <!-- åŠ ç­æ—¥åˆ—è¡¨ -->
        <div id="overtimeDaysContainer">
            <!-- åŠ ç­æ—¥æ¢ç›®å°‡å‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->
        </div>

        <!-- æ–°å¢åŠ ç­æ—¥æŒ‰éˆ• -->
        <button id="addOvertimeDayBtn" class="btn btn-outline w-full mb-6">
            + æ–°å¢åŠ ç­æ—¥
        </button>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="flex-container">
            <button id="calculateBtn" class="btn btn-primary flex-grow">è¨ˆç®—åŠ ç­è²»èˆ‡è£œåŠ©</button>
            <button id="clearAllBtn" class="btn btn-secondary flex-grow">æ¸…é™¤æ‰€æœ‰</button>
        </div>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <div id="results" class="results-area hidden">
            <h3 class="text-center">ğŸ“Š æœ¬æœˆåŠ ç­åŠè£œåŠ©çµ±è¨ˆ</h3>
            <p>ğŸ”¹ æœˆè–ªï¼š<strong id="displayMonthlySalary"></strong> å…ƒ</p>
            <p>ğŸ’° é ä¼°æ™‚è–ªï¼š<strong id="displayHourlyWage"></strong> å…ƒ</p>
            <p>ğŸ—“ï¸ å¯¦éš›åŠ ç­å¤©æ•¸ï¼š<strong id="displayTotalOvertimeDays"></strong> å¤©</p>
            <p>â±ï¸ ç¸½åŠ ç­æ™‚æ•¸ï¼š<strong id="displayTotalOvertimeHours"></strong> å°æ™‚</p>
            <hr class="my-4 border-gray-300">
            <p>ğŸ’² ç´”åŠ ç­è²»ï¼šç´„ <strong id="displayPureOvertimePay"></strong> å…ƒ</p>
            <p>ğŸœ ä¸­é¤è£œåŠ©ï¼šç´„ <strong id="displayLunchSubsidy"></strong> å…ƒ</p>
            <p>ğŸ åŠ ç­é¤è²»è£œåŠ©ï¼šç´„ <strong id="displayOvertimeMealSubsidy"></strong> å…ƒ</p>
            <hr class="my-4 border-gray-300">
            <p class="text-red-600">â– ç—…å‡æ‰£æ¬¾ï¼šç´„ <strong id="displaySickLeaveDeduction"></strong> å…ƒ</p>
            <p class="text-red-600">â– äº‹å‡æ‰£æ¬¾ï¼šç´„ <strong id="displayPersonalLeaveDeduction"></strong> å…ƒ</p>
            <hr class="my-4 border-gray-300">
            <p class="text-red-600">â– å‹ä¿è²»æ‰£é™¤ï¼šç´„ <strong id="displayLaborInsuranceDeduction"></strong> å…ƒ</p>
            <p class="text-red-600">â– å¥ä¿è²»æ‰£é™¤ï¼šç´„ <strong id="displayHealthInsuranceDeduction"></strong> å…ƒ</p>
            <hr class="my-4 border-gray-300">
            <p class="text-lg font-bold">ğŸ’° ç¸½è¨ˆ (åŠ ç­è²» + è£œåŠ© - æ‰£æ¬¾)ï¼šç´„ <strong id="displayGrandTotalPay"></strong> å…ƒ</p>
            <p class="text-sm text-gray-600 mt-4">
                <small>
                    è¨»ï¼šä¼‘æ¯æ—¥åŠ ç­è²»ç‡è¨ˆç®—æœªè€ƒæ…®æœ€ä½çµ¦ä»˜æ™‚æ•¸ï¼ˆå¦‚åŠ ç­1å°æ™‚çµ¦4å°æ™‚å·¥è³‡ï¼‰ï¼Œåƒ…ä¾å¯¦éš›åŠ ç­æ™‚æ•¸ç´¯è¨ˆè²»ç‡ã€‚è‹¥éœ€ç²¾ç¢ºç¬¦åˆæ³•è¦ï¼Œè«‹åƒè€ƒå‹å‹•éƒ¨ç›¸é—œè¦å®šã€‚
                    <br>
                    è«‹å‡æ‰£æ¬¾è¨ˆç®—åŸºæ–¼æ¯æœˆç¸½å·¥ä½œå¤©æ•¸åŠæ™‚è–ªã€‚æ‰€æœ‰è«‹å‡å¤©æ•¸çš†ä¸è¨ˆç®—ä¸­é¤è£œåŠ©ã€‚
                    <br>
                    **åŠ ç­æ™‚æ•¸å¿…é ˆè‡³å°‘ç‚º 1 å°æ™‚æ‰è¨ˆå…¥åŠ ç­è²»åŠæ™‚æ•¸ã€‚**
                    <br>
                    **åŠ ç­é¤è²»è£œåŠ©éœ€åŠ ç­æ™‚æ•¸å¤§æ–¼æˆ–ç­‰æ–¼ 2 å°æ™‚æ‰å¯ç²å¾—ã€‚**
                    <br>
                    **é¤è£œè¨ˆç®—ä¾å…¬å¸åç¨±åˆ¤æ–·ï¼šåƒ…ã€Œå»£é”ã€è¨ˆç®—é¤è£œã€‚**
                    <br>
                    **å‹å¥ä¿è²»ç‡èˆ‡ç´šè·ç‚ºå…§å»ºå›ºå®šè³‡æ–™ï¼Œå¯èƒ½ç„¡æ³•å³æ™‚åæ˜ æœ€æ–°å…¬å‘Šã€‚**
                </small>
            </p>
        </div>
    </div>

    <script>
        // DOM elements
        const companyNameSelect = document.getElementById('companyName'); // Changed to select
        const monthlySalaryInput = document.getElementById('monthlySalary');
        const deductInsuranceCheckbox = document.getElementById('deductInsuranceCheckbox');
        const dependentsInputGroup = document.getElementById('dependentsInputGroup');
        const healthInsuranceDependentsInput = document.getElementById('healthInsuranceDependents');
        const calcYearSelect = document.getElementById('calcYear');
        const calcMonthSelect = document.getElementById('calcMonth');
        const totalWorkingDaysInput = document.getElementById('totalWorkingDays');
        const salaryError = document.getElementById('salaryError');
        const workingDaysError = document.getElementById('workingDaysError');
        
        const leaveRecordsContainer = document.getElementById('leaveRecordsContainer');
        const addLeaveDayBtn = document.getElementById('addLeaveDayBtn');

        const overtimeDaysContainer = document.getElementById('overtimeDaysContainer');
        const addOvertimeDayBtn = document.getElementById('addOvertimeDayBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const resultsArea = document.getElementById('results');
        const currentMonthDisplay = document.getElementById('currentMonthDisplay');

        // Result display elements
        const displayMonthlySalary = document.getElementById('displayMonthlySalary');
        const displayHourlyWage = document.getElementById('displayHourlyWage');
        const displayTotalOvertimeDays = document.getElementById('displayTotalOvertimeDays');
        const displayTotalOvertimeHours = document.getElementById('displayTotalOvertimeHours');
        const displayPureOvertimePay = document.getElementById('displayPureOvertimePay');
        const displayLunchSubsidy = document.getElementById('displayLunchSubsidy');
        const displayOvertimeMealSubsidy = document.getElementById('displayOvertimeMealSubsidy');
        const displaySickLeaveDeduction = document.getElementById('displaySickLeaveDeduction');
        const displayPersonalLeaveDeduction = document.getElementById('displayPersonalLeaveDeduction');
        const displayLaborInsuranceDeduction = document.getElementById('displayLaborInsuranceDeduction');
        const displayHealthInsuranceDeduction = document.getElementById('displayHealthInsuranceDeduction');
        const displayGrandTotalPay = document.getElementById('displayGrandTotalPay');

        let overtimeEntries = []; // Stores data for each overtime entry (type and hours)
        let leaveEntries = []; // Stores data for each leave entry (date, type and duration)

        // Initialize current month display
        const now = new Date();
        let currentYear = now.getFullYear();
        let currentMonth = now.getMonth() + 1; // getMonth() returns 0-11, so add 1
        currentMonthDisplay.textContent = `${currentYear} å¹´ ${currentMonth} æœˆ`;

        // Local Storage Key
        const LOCAL_STORAGE_KEY = 'overtimeCalculatorDataV11'; // Updated key for new version

        // Taiwan Public Holidays (YYYY-MM-DD format) - Fixed list
        // Data sourced from è¡Œæ”¿é™¢äººäº‹è¡Œæ”¿ç¸½è™• (Directorate-General of Personnel Administration, Executive Yuan)
        // Note: This list is static and might not reflect last-minute changes or special adjustments (e.g., make-up workdays).
        // Users are advised to manually verify for critical accuracy.
        const publicHolidays = new Set([
            // 2024
            "2024-01-01", // å…ƒæ—¦
            "2024-02-08", "2024-02-09", "2024-02-10", "2024-02-11", "2024-02-12", "2024-02-13", "2024-02-14", // è¾²æ›†æ˜¥ç¯€ (é™¤å¤•è‡³åˆäº”ï¼Œå«èª¿æ•´æ”¾å‡)
            "2024-02-28", // å’Œå¹³ç´€å¿µæ—¥
            "2024-04-04", // å…’ç«¥ç¯€
            "2024-04-05", // æ¸…æ˜ç¯€
            "2024-05-01", // å‹å‹•ç¯€ (é©ç”¨å‹åŸºæ³•å‹å·¥)
            "2024-06-10", // ç«¯åˆç¯€
            "2024-09-17", // ä¸­ç§‹ç¯€
            "2024-10-10", // åœ‹æ…¶æ—¥

            // 2025
            "2025-01-01", // å…ƒæ—¦
            "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31", "2025-02-01", "2025-02-02", "2025-02-03", "2025-02-04", // è¾²æ›†æ˜¥ç¯€ (é™¤å¤•è‡³åˆäº”ï¼Œå«èª¿æ•´æ”¾å‡)
            "2025-02-28", // å’Œå¹³ç´€å¿µæ—¥
            "2025-04-04", // å…’ç«¥ç¯€
            "2025-04-05", // æ¸…æ˜ç¯€
            "2025-05-01", // å‹å‹•ç¯€ (é©ç”¨å‹åŸºæ³•å‹å·¥)
            "2025-06-02", // ç«¯åˆç¯€ (è£œå‡ï¼Œå› 5/31ç‚ºé€±å…­)
            "2025-10-06", // ä¸­ç§‹ç¯€
            "2025-10-10", // åœ‹æ…¶æ—¥

            // 2026
            "2026-01-01", // å…ƒæ—¦
            "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20", "2026-02-21", "2026-02-22", "2026-02-23", // è¾²æ›†æ˜¥ç¯€ (é™¤å¤•è‡³åˆäº”ï¼Œå«èª¿æ•´æ”¾å‡)
            "2026-02-28", // å’Œå¹³ç´€å¿µæ—¥ (é€±å…­)
            "2026-04-04", // å…’ç«¥ç¯€ (é€±å…­)
            "2026-04-05", // æ¸…æ˜ç¯€ (é€±æ—¥)
            "2026-05-01", // å‹å‹•ç¯€ (é©ç”¨å‹åŸºæ³•å‹å·¥)
            "2026-06-19", // ç«¯åˆç¯€
            "2026-09-25", // ä¸­ç§‹ç¯€
            "2026-10-10", // åœ‹æ…¶æ—¥ (é€±å…­)
        ]);

        // å‹å·¥ä¿éšªæŠ•ä¿è–ªè³‡åˆ†ç´šè¡¨ (åƒ…åˆ—å‡ºéƒ¨åˆ†ç´šè·ï¼Œå¯¦éš›è«‹åƒè€ƒå‹ä¿å±€å…¬å‘Š)
        // å‹å·¥è² æ“”æ¯”ä¾‹ï¼š11% (å‹ä¿æ™®é€šäº‹æ•…ä¿éšªè²»ç‡) * 20% (å‹å·¥è² æ“”æ¯”ä¾‹) = 2.2%
        // è·æ¥­ç½å®³ä¿éšªè²»ç‡ç”±é›‡ä¸»å…¨é¡è² æ“”ï¼Œæ•…ä¸è¨ˆå…¥å‹å·¥è‡ªä»˜é¡ã€‚
        const laborInsuranceTiers = [
            { min: 11100, max: 27600, base: 27600 },
            { min: 27601, max: 28800, base: 28800 },
            { min: 28801, max: 30300, base: 30300 },
            { min: 30301, max: 31800, base: 31800 },
            { min: 31801, max: 33300, base: 33300 },
            { min: 33301, max: 34800, base: 34800 },
            { min: 34801, max: 36300, base: 36300 },
            { min: 36301, max: 38200, base: 38200 },
            { min: 38201, max: 40100, base: 40100 },
            { min: 40101, max: 42000, base: 42000 },
            { min: 42001, max: 43900, base: 43900 },
            { min: 43901, max: 45800, base: 45800 },
            { min: 45801, max: 48200, base: 48200 },
            { min: 48201, max: 50600, base: 50600 },
            { min: 50601, max: 53000, base: 53000 },
            { min: 53001, max: 55400, base: 55400 },
            { min: 55401, max: 57800, base: 57800 },
            { min: 57801, max: 60800, base: 60800 },
            { min: 60801, max: 64100, base: 64100 },
            { min: 64101, max: 67400, base: 67400 },
            { min: 67401, max: 71200, base: 71200 },
            { min: 71201, max: 76500, base: 76500 },
            { min: 76501, max: 80800, base: 80800 },
            { min: 80801, max: 87800, base: 87800 },
            { min: 87801, max: 92100, base: 92100 },
            { min: 92101, max: 98800, base: 98800 },
            { min: 98801, max: 106700, base: 106700 },
            { min: 106701, max: 115500, base: 115500 },
            { min: 115501, max: 126300, base: 126300 },
            { min: 126301, max: 137200, base: 137200 },
            { min: 137201, max: 150000, base: 150000 },
            { min: 150001, max: 160000, base: 160000 },
            { min: 160001, max: 170000, base: 170000 },
            { min: 170001, max: 180000, base: 180000 },
            { min: 180001, max: 190000, base: 190000 },
            { min: 190001, max: 200000, base: 200000 },
            { min: 200001, max: 210000, base: 210000 },
            { min: 210001, max: 220000, base: 220000 },
            { min: 220001, max: 230000, base: 230000 },
            { min: 230001, max: 240000, base: 240000 },
            { min: 240001, max: 250000, base: 250000 },
            { min: 250001, max: 260000, base: 260000 },
            { min: 260001, max: 270000, base: 270000 },
            { min: 270001, max: 280000, base: 280000 },
            { min: 280001, max: 290000, base: 290000 },
            { min: 290001, max: 300000, base: 300000 },
            { min: 300001, max: 310000, base: 310000 },
            { min: 310001, max: 320000, base: 320000 },
            { min: 320001, max: 330000, base: 330000 },
            { min: 330001, max: 340000, base: 340000 },
            { min: 340001, max: 350000, base: 350000 },
            { min: 350001, max: 360000, base: 360000 },
            { min: 360001, max: 370000, base: 370000 },
            { min: 370001, max: 380000, base: 380000 },
            { min: 380001, max: 390000, base: 390000 },
            { min: 390001, max: 400000, base: 400000 },
            { min: 400001, max: 410000, base: 410000 },
            { min: 410001, max: 420000, base: 420000 },
            { min: 420001, max: 430000, base: 430000 },
            { min: 430001, max: 440000, base: 440000 },
            { min: 440001, max: 450000, base: 450000 },
            { min: 450001, max: 460000, base: 460000 },
            { min: 460001, max: 470000, base: 470000 },
            { min: 470001, max: 480000, base: 480000 },
            { min: 480001, max: 490000, base: 490000 },
            { min: 490001, max: 500000, base: 500000 },
            { min: 500001, max: 510000, base: 510000 },
            { min: 510001, max: 520000, base: 520000 },
            { min: 520001, max: 530000, base: 530000 },
            { min: 530001, max: 540000, base: 540000 },
            { min: 540001, max: 550000, base: 550000 },
            { min: 550001, max: 560000, base: 560000 },
            { min: 560001, max: 570000, base: 570000 },
            { min: 570001, max: 580000, base: 580000 },
            { min: 580001, max: 590000, base: 590000 },
            { min: 590001, max: 600000, base: 600000 },
            { min: 600001, max: 610000, base: 610000 },
            { min: 610001, max: 620000, base: 620000 },
            { min: 620001, max: 630000, base: 630000 },
            { min: 630001, max: 640000, base: 640000 },
            { min: 640001, max: 650000, base: 650000 },
            { min: 650001, max: 660000, base: 660000 },
            { min: 660001, max: 670000, base: 670000 },
            { min: 670001, max: 680000, base: 680000 },
            { min: 680001, max: 690000, base: 690000 },
            { min: 690001, max: 700000, base: 700000 },
            { min: 700001, max: 710000, base: 710000 },
            { min: 710001, max: 720000, base: 720000 },
            { min: 720001, max: 730000, base: 730000 },
            { min: 730001, max: 740000, base: 740000 },
            { min: 740001, max: 750000, base: 750000 },
            { min: 750001, max: 760000, base: 760000 },
            { min: 760001, max: 770000, base: 770000 },
            { min: 770001, max: 780000, base: 780000 },
            { min: 780001, max: 790000, base: 790000 },
            { min: 790001, max: 800000, base: 800000 },
            { min: 800001, max: 810000, base: 810000 },
            { min: 810001, max: 820000, base: 820000 },
            { min: 820001, max: 830000, base: 830000 },
            { min: 830001, max: 840000, base: 840000 },
            { min: 840001, max: 850000, base: 850000 },
            { min: 850001, max: 860000, base: 860000 },
            { min: 860001, max: 870000, base: 870000 },
            { min: 870001, max: 880000, base: 880000 },
            { min: 880001, max: 890000, base: 890000 },
            { min: 890001, max: 900000, base: 900000 },
            { min: 900001, max: 910000, base: 910000 },
            { min: 910001, max: 920000, base: 920000 },
            { min: 920001, max: 930000, base: 930000 },
            { min: 930001, max: 940000, base: 940000 },
            { min: 940001, max: 950000, base: 950000 },
            { min: 950001, max: 960000, base: 960000 },
            { min: 960001, max: 970000, base: 970000 },
            { min: 970001, max: 980000, base: 980000 },
            { min: 980001, max: 990000, base: 990000 },
            { min: 990001, max: 1000000, base: 1000000 },
            { min: 1000001, max: Infinity, base: 1000000 } // æœ€é«˜ç´šè·
        ];
        const laborInsuranceRate = 0.11; // å‹ä¿æ™®é€šäº‹æ•…ä¿éšªè²»ç‡ 11%
        const laborInsuranceEmployeeShare = 0.20; // å‹å·¥è² æ“”æ¯”ä¾‹ 20% (è‡ªä»˜20%ï¼Œé›‡ä¸»70%ï¼Œæ”¿åºœ10%)

        // å…¨æ°‘å¥åº·ä¿éšªæŠ•ä¿é‡‘é¡åˆ†ç´šè¡¨ (åƒ…åˆ—å‡ºéƒ¨åˆ†ç´šè·ï¼Œå¯¦éš›è«‹åƒè€ƒå¥ä¿ç½²å…¬å‘Š)
        // å¥ä¿è²»ç‡ï¼š5.17% (ç›®å‰è²»ç‡)
        // å‹å·¥è² æ“”æ¯”ä¾‹ï¼š30% (è‡ªä»˜30%ï¼Œé›‡ä¸»60%ï¼Œæ”¿åºœ10%)
        const healthInsuranceTiers = [
            { min: 27470, max: 28800, base: 28800 },
            { min: 28801, max: 30300, base: 30300 },
            { min: 30301, max: 31800, base: 31800 },
            { min: 31801, max: 33300, base: 33300 },
            { min: 33301, max: 34800, base: 34800 },
            { min: 34801, max: 36300, base: 36300 },
            { min: 36301, max: 38200, base: 38200 },
            { min: 38201, max: 40100, base: 40100 },
            { min: 40101, max: 42000, base: 42000 },
            { min: 42001, max: 43900, base: 43900 },
            { min: 43901, max: 45800, base: 45800 },
            { min: 45801, max: 48200, base: 48200 },
            { min: 48201, max: 50600, base: 50600 },
            { min: 50601, max: 53000, base: 53000 },
            { min: 53001, max: 55400, base: 55400 },
            { min: 55401, max: 57800, base: 57800 },
            { min: 57801, max: 60800, base: 60800 },
            { min: 60801, max: 64100, base: 64100 },
            { min: 64101, max: 67400, base: 67400 },
            { min: 67401, max: 71200, base: 71200 },
            { min: 71201, max: 76500, base: 76500 },
            { min: 76501, max: 80800, base: 80800 },
            { min: 80801, max: 87800, base: 87800 },
            { min: 87801, max: 92100, base: 92100 },
            { min: 92101, max: 98800, base: 98800 },
            { min: 98801, max: 106700, base: 106700 },
            { min: 106701, max: 115500, base: 115500 },
            { min: 115501, max: 126300, base: 126300 },
            { min: 126301, max: 137200, base: 137200 },
            { min: 137201, max: 150000, base: 150000 },
            { min: 150001, max: 160000, base: 160000 },
            { min: 160001, max: 170000, base: 170000 },
            { min: 170001, max: 180000, base: 180000 },
            { min: 180001, max: 190000, base: 190000 },
            { min: 190001, max: 200000, base: 200000 },
            { min: 200001, max: 210000, base: 210000 },
            { min: 210001, max: 220000, base: 220000 },
            { min: 220001, max: 230000, base: 230000 },
            { min: 230001, max: 240000, base: 240000 },
            { min: 240001, max: Infinity, base: 240000 } // æœ€é«˜ç´šè·
        ];
        const healthInsuranceRate = 0.0517; // å¥ä¿è²»ç‡ 5.17%
        const healthInsuranceEmployeeShare = 0.30; // å‹å·¥è² æ“”æ¯”ä¾‹ 30% (è‡ªä»˜30%ï¼Œé›‡ä¸»60%ï¼Œæ”¿åºœ10%)

        // Function: Get Labor Insurance Contribution Base
        function getLaborInsuranceBase(salary) {
            for (const tier of laborInsuranceTiers) {
                if (salary >= tier.min && salary <= tier.max) {
                    return tier.base;
                }
            }
            return laborInsuranceTiers[laborInsuranceTiers.length - 1].base; // Fallback to highest tier
        }

        // Function: Get Health Insurance Contribution Base
        function getHealthInsuranceBase(salary) {
            for (const tier of healthInsuranceTiers) {
                if (salary >= tier.min && salary <= tier.max) {
                    return tier.base;
                }
            }
            return healthInsuranceTiers[healthInsuranceTiers.length - 1].base; // Fallback to highest tier
        }

        // Function: Populate Year and Month Selectors
        function populateMonthYearSelectors() {
            const startYear = 2024; // Start year for selection
            const endYear = currentYear + 2; // Current year + 2 years for future planning

            for (let y = startYear; y <= endYear; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = `${y} å¹´`;
                calcYearSelect.appendChild(option);
            }

            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = `${m} æœˆ`;
                calcMonthSelect.appendChild(option);
            }

            // Set default to current year and month
            calcYearSelect.value = currentYear;
            calcMonthSelect.value = currentMonth;

            // Add event listeners for changes
            calcYearSelect.addEventListener('change', () => {
                currentYear = parseInt(calcYearSelect.value);
                currentMonthDisplay.textContent = `${currentYear} å¹´ ${currentMonth} æœˆ`;
                saveData(); // Save selected year/month
            });
            calcMonthSelect.addEventListener('change', () => {
                currentMonth = parseInt(calcMonthSelect.value);
                currentMonthDisplay.textContent = `${currentYear} å¹´ ${currentMonth} æœˆ`;
                saveData(); // Save selected year/month
            });
        }

        // Function: Generate overtime hours options (1.0 to 6.0, in 0.5 increments)
        function generateOvertimeHoursOptions(selectedValue = 1.0) { // Default to 1.0 hour
            let optionsHtml = '';
            for (let i = 1.0; i <= 6; i += 0.5) { // Start from 1.0
                const selected = (i === selectedValue) ? 'selected' : '';
                optionsHtml += `<option value="${i}" ${selected}>${i} å°æ™‚</option>`;
            }
            return optionsHtml;
        }

        // Function: Generate leave duration options (0.5 to 5.0, in 0.5 increments)
        function generateLeaveDurationOptions(selectedValue = 1) {
            let optionsHtml = '';
            for (let i = 0.5; i <= 5; i += 0.5) {
                const selected = (i === selectedValue) ? 'selected' : '';
                optionsHtml += `<option value="${i}" ${selected}>${i} å¤©</option>`;
            }
            return optionsHtml;
        }

        // Function: Add an overtime entry row
        function addOvertimeDayEntry(data = {}) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry-item'; // Unified style
            const uniqueIndex = Date.now() + Math.random(); 
            entryDiv.dataset.index = uniqueIndex; 

            entryDiv.innerHTML = `
                <div class="flex-grow">
                    <label for="overtimeDate-${uniqueIndex}" class="block mb-2 text-sm font-medium text-gray-400">åŠ ç­æ—¥æœŸ</label>
                    <input type="date" id="overtimeDate-${uniqueIndex}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex-grow">
                    <label for="overtimeType-${uniqueIndex}" class="block mb-2 text-sm font-medium text-gray-400">åŠ ç­é¡å‹</label>
                    <select id="overtimeType-${uniqueIndex}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="weekday">å¹³æ—¥åŠ ç­</option>
                        <option value="restDay">ä¼‘æ¯æ—¥åŠ ç­</option>
                        <option value="holiday">åœ‹å®šå‡æ—¥åŠ ç­</option>
                    </select>
                </div>
                <div class="flex-grow">
                    <label for="overtimeHours-${uniqueIndex}" class="block mb-2 text-sm font-medium text-gray-400">åŠ ç­æ™‚æ•¸</label>
                    <select id="overtimeHours-${uniqueIndex}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        ${generateOvertimeHoursOptions(data.hours || 1.0)}
                    </select>
                </div>
                <button type="button" class="remove-btn btn btn-danger text-sm px-3 py-2">ç§»é™¤</button>
            `;
            
            overtimeDaysContainer.appendChild(entryDiv);
            const newEntry = {
                element: entryDiv,
                dateInput: entryDiv.querySelector('input[type="date"]'),
                typeSelect: entryDiv.querySelector('select[id^="overtimeType-"]'),
                hoursSelect: entryDiv.querySelector('select[id^="overtimeHours-"]')
            };
            overtimeEntries.push(newEntry);

            entryDiv.querySelector('.remove-btn').addEventListener('click', () => {
                removeEntry(entryDiv, overtimeEntries);
                saveData();
            });

            newEntry.dateInput.value = data.date || `${currentYear}-${currentMonth.toString().padStart(2, '0')}-01`;
            newEntry.typeSelect.value = data.type || 'weekday';
            newEntry.hoursSelect.value = data.hours || 1.0; // Default to 1.0 hour

            newEntry.dateInput.addEventListener('change', saveData);
            newEntry.typeSelect.addEventListener('change', saveData);
            newEntry.hoursSelect.addEventListener('change', saveData);

            saveData();
        }

        // Function: Add a leave entry row
        function addLeaveDayEntry(data = {}) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry-item'; // Unified style
            const uniqueIndex = Date.now() + Math.random(); 
            entryDiv.dataset.index = uniqueIndex; 

            entryDiv.innerHTML = `
                <div class="flex-grow">
                    <label for="leaveDate-${uniqueIndex}" class="block mb-2 text-sm font-medium text-gray-400">è«‹å‡æ—¥æœŸ</label>
                    <input type="date" id="leaveDate-${uniqueIndex}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex-grow">
                    <label for="leaveType-${uniqueIndex}" class="block mb-2 text-sm font-medium text-gray-400">å‡åˆ¥</label>
                    <select id="leaveType-${uniqueIndex}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="sickLeave">ç—…å‡ (åŠè–ª)</option>
                        <option value="personalLeave">äº‹å‡ (ç„¡è–ª)</option>
                        <option value="annualLeave">ç‰¹ä¼‘ (å…¨è–ª)</option>
                        <option value="marriageLeave">å©šå‡ (å…¨è–ª)</option>
                        <option value="bereavementLeave">å–ªå‡ (å…¨è–ª)</option>
                        <option value="officialLeave">å…¬å‡ (å…¨è–ª)</option>
                        <option value="maternityLeave">ç”¢å‡ (å…¨è–ª)</option>
                        <option value="menstrualLeave">ç”Ÿç†å‡ (åŠè–ª)</option>
                        <option value="typhoonLeave">é¢±é¢¨å‡ (ä¸æ‰£è–ª)</option>
                        <option value="occupationalInjuryLeave">å…¬å‚·ç—…å‡ (å…¨è–ª)</option>
                    </select>
                </div>
                <div class="flex-grow">
                    <label for="leaveDuration-${uniqueIndex}" class="block mb-2 text-sm font-medium text-gray-400">è«‹å‡å¤©æ•¸</label>
                    <select id="leaveDuration-${uniqueIndex}" class="w-full p-2 border border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        ${generateLeaveDurationOptions(data.duration || 1)}
                    </select>
                </div>
                <button type="button" class="remove-btn btn btn-danger text-sm px-3 py-2">ç§»é™¤</button>
            `;
            
            leaveRecordsContainer.appendChild(entryDiv);
            const newEntry = {
                element: entryDiv,
                dateInput: entryDiv.querySelector('input[type="date"]'),
                typeSelect: entryDiv.querySelector('select[id^="leaveType-"]'),
                durationSelect: entryDiv.querySelector('select[id^="leaveDuration-"]')
            };
            leaveEntries.push(newEntry);

            entryDiv.querySelector('.remove-btn').addEventListener('click', () => {
                removeEntry(entryDiv, leaveEntries);
                saveData();
            });

            newEntry.dateInput.value = data.date || `${currentYear}-${currentMonth.toString().padStart(2, '0')}-01`;
            newEntry.typeSelect.value = data.type || 'sickLeave';
            newEntry.durationSelect.value = data.duration || 1; 

            newEntry.dateInput.addEventListener('change', saveData);
            newEntry.typeSelect.addEventListener('change', saveData);
            newEntry.durationSelect.addEventListener('change', saveData);

            saveData();
        }

        // Function: Generic remove entry
        function removeEntry(entryDiv, entryArray) {
            entryDiv.parentNode.removeChild(entryDiv);
            // Remove the corresponding data from the array based on element reference
            const index = entryArray.indexOf(entryArray.find(e => e.element === entryDiv));
            if (index > -1) {
                entryArray.splice(index, 1);
            }
        }

        // Function: Calculate working days in a specific month (Mon-Fri, excluding public holidays)
        function getWorkingDaysInMonth(year, month) {
            let workingDays = 0;
            const date = new Date(year, month - 1, 1); // Month is 0-indexed for Date constructor
            while (date.getMonth() === month - 1) {
                const day = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                // Format current date for holiday check
                const yyyy = date.getFullYear();
                const mm = (date.getMonth() + 1).toString().padStart(2, '0');
                const dd = date.getDate().toString().padStart(2, '0');
                const currentDateStr = `${yyyy}-${mm}-${dd}`;

                // Exclude Sunday (0) and Saturday (6) AND public holidays
                if (day !== 0 && day !== 6 && !publicHolidays.has(currentDateStr)) {
                    workingDays++;
                }
                date.setDate(date.getDate() + 1);
            }
            return workingDays;
        }

        // Function: Save data to localStorage
        function saveData() {
            const data = {
                companyName: companyNameSelect.value, // Save selected value
                monthlySalary: monthlySalaryInput.value,
                deductInsurance: deductInsuranceCheckbox.checked,
                healthInsuranceDependents: healthInsuranceDependentsInput.value,
                calcYear: calcYearSelect.value,
                calcMonth: calcMonthSelect.value,
                totalWorkingDays: totalWorkingDaysInput.value,
                overtimeEntries: overtimeEntries.map(entry => ({
                    date: entry.dateInput.value,
                    type: entry.typeSelect.value,
                    hours: parseFloat(entry.hoursSelect.value)
                })),
                leaveEntries: leaveEntries.map(entry => ({
                    date: entry.dateInput.value,
                    type: entry.typeSelect.value,
                    duration: parseFloat(entry.durationSelect.value)
                }))
            };
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        // Function: Load data from localStorage
        function loadData() {
            try {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    companyNameSelect.value = data.companyName || 'éå»£é”'; // Load selected value, default to 'éå»£é”'
                    monthlySalaryInput.value = data.monthlySalary || '';
                    deductInsuranceCheckbox.checked = data.deductInsurance || false;
                    healthInsuranceDependentsInput.value = data.healthInsuranceDependents || '0';
                    
                    if (deductInsuranceCheckbox.checked) {
                        dependentsInputGroup.classList.add('active');
                    } else {
                        dependentsInputGroup.classList.remove('active');
                    }

                    calcYearSelect.value = data.calcYear || currentYear;
                    calcMonthSelect.value = data.calcMonth || currentMonth;
                    currentYear = parseInt(calcYearSelect.value);
                    currentMonth = parseInt(calcMonthSelect.value);
                    currentMonthDisplay.textContent = `${currentYear} å¹´ ${currentMonth} æœˆ`;

                    overtimeDaysContainer.innerHTML = '';
                    overtimeEntries = [];
                    leaveRecordsContainer.innerHTML = '';
                    leaveEntries = [];

                    if (data.overtimeEntries && data.overtimeEntries.length > 0) {
                        data.overtimeEntries.forEach(entryData => addOvertimeDayEntry(entryData));
                    } else {
                        addOvertimeDayEntry(); 
                    }

                    if (data.leaveEntries && data.leaveEntries.length > 0) {
                        data.leaveEntries.forEach(entryData => addLeaveDayEntry(entryData));
                    } else {
                        addLeaveDayEntry(); 
                    }

                } else {
                    addOvertimeDayEntry(); 
                    addLeaveDayEntry(); 
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                clearAll(); 
            }
        }

        // Function: Calculate overtime and leave deductions
        function calculateOvertimeAndLeave() {
            // Hide all error messages and results
            salaryError.classList.add('hidden');
            workingDaysError.classList.add('hidden');
            resultsArea.classList.add('hidden');

            let companyName = companyNameSelect.value; // Get selected value
            let monthlySalary = parseFloat(monthlySalaryInput.value);
            let totalWorkingDaysCalculated;

            if (isNaN(monthlySalary) || monthlySalary <= 0) {
                salaryError.classList.remove('hidden');
                return;
            }

            if (totalWorkingDaysInput.value.trim() === '') {
                totalWorkingDaysCalculated = getWorkingDaysInMonth(parseInt(calcYearSelect.value), parseInt(calcMonthSelect.value));
                workingDaysError.classList.add('hidden');
            } else {
                totalWorkingDaysCalculated = parseFloat(totalWorkingDaysInput.value);
                if (isNaN(totalWorkingDaysCalculated) || totalWorkingDaysCalculated <= 0) { 
                    workingDaysError.classList.remove('hidden');
                    return;
                }
            }

            const standardMonthlyHours = 240;
            let hourlyWage = monthlySalary / standardMonthlyHours;
            const dailySalary = hourlyWage * 8;

            // --- Overtime Calculation ---
            let pureOvertimePay = 0; 
            let totalOvertimeHours = 0; 
            let actualOvertimeDaysCount = 0; 
            let totalOvertimeMealSubsidy = 0; 

            // Check if company is Quanta for meal subsidies
            const isQuanta = (companyName === 'å»£é”'); // Simplified check

            for (let i = 0; i < overtimeEntries.length; i++) {
                const entry = overtimeEntries[i];
                const overtimeType = entry.typeSelect.value;
                let dailyHours = parseFloat(entry.hoursSelect.value); 

                if (isNaN(dailyHours)) {
                    alert(`ç¬¬ ${i + 1} å€‹åŠ ç­æ—¥çš„æ™‚æ•¸é¸æ“‡ç„¡æ•ˆï¼Œè«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„æ™‚æ•¸ã€‚`);
                    return; 
                }

                let effectiveDailyHours = dailyHours;
                if (dailyHours > 0 && dailyHours < 1) { 
                    effectiveDailyHours = 0; 
                }

                if (effectiveDailyHours > 0) { 
                    actualOvertimeDaysCount++; 
                }
                
                let dailyPay = 0;

                if (effectiveDailyHours > 0) { 
                    switch (overtimeType) {
                        case "weekday":
                            if (effectiveDailyHours <= 2) {
                                dailyPay = effectiveDailyHours * hourlyWage * 1.33;
                            } else { 
                                dailyPay = (2 * hourlyWage * 1.33) + ((effectiveDailyHours - 2) * hourlyWage * 1.66);
                            }
                            break;
                        case "restDay":
                            if (effectiveDailyHours <= 2) {
                                dailyPay = effectiveDailyHours * hourlyWage * 1.33;
                            } else if (effectiveDailyHours <= 8) {
                                dailyPay = (2 * hourlyWage * 1.33) + ((effectiveDailyHours - 2) * hourlyWage * 1.66);
                            } else { 
                                dailyPay = (2 * hourlyWage * 1.33) + (6 * hourlyWage * 1.66) + ((effectiveDailyHours - 8) * hourlyWage * 2.66);
                            }
                            break;
                        case "holiday":
                            dailyPay = effectiveDailyHours * hourlyWage * 2.00;
                            break;
                    }
                }
                pureOvertimePay += dailyPay;
                totalOvertimeHours += effectiveDailyHours; 

                if (isQuanta && effectiveDailyHours >= 2) { 
                    totalOvertimeMealSubsidy += 60;
                }
            }

            // --- Leave Deduction Calculation ---
            let totalSickLeaveDays = 0;
            let totalPersonalLeaveDays = 0;
            let sickLeaveDeduction = 0;
            let personalLeaveDeduction = 0;
            let totalLeaveDaysForLunchSubsidy = 0;

            for (let i = 0; i < leaveEntries.length; i++) {
                const entry = leaveEntries[i];
                const leaveType = entry.typeSelect.value;
                const leaveDuration = parseFloat(entry.durationSelect.value);

                if (isNaN(leaveDuration) || leaveDuration < 0) {
                    alert(`ç¬¬ ${i + 1} å€‹è«‹å‡è¨˜éŒ„çš„å¤©æ•¸é¸æ“‡ç„¡æ•ˆï¼Œè«‹é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„å¤©æ•¸ã€‚`);
                    return;
                }

                totalLeaveDaysForLunchSubsidy += leaveDuration;

                switch (leaveType) {
                    case "sickLeave":
                    case "menstrualLeave": 
                        totalSickLeaveDays += leaveDuration;
                        sickLeaveDeduction += leaveDuration * dailySalary * 0.5;
                        break;
                    case "personalLeave":
                        totalPersonalLeaveDays += leaveDuration;
                        personalLeaveDeduction += leaveDuration * dailySalary * 1.0;
                        break;
                    case "annualLeave":
                    case "marriageLeave":
                    case "bereavementLeave":
                    case "officialLeave":
                    case "maternityLeave":
                    case "occupationalInjuryLeave":
                    case "typhoonLeave": 
                        break;
                }
            }

            let lunchSubsidy = 0;
            if (isQuanta) {
                const daysCountedForLunchSubsidy = Math.max(0, totalWorkingDaysCalculated - totalLeaveDaysForLunchSubsidy); 
                lunchSubsidy = daysCountedForLunchSubsidy * 55;
            }
            
            // --- Labor and Health Insurance Deduction Calculation ---
            let laborInsuranceDeduction = 0;
            let healthInsuranceDeduction = 0;

            if (deductInsuranceCheckbox.checked) {
                const laborBase = getLaborInsuranceBase(monthlySalary);
                laborInsuranceDeduction = laborBase * laborInsuranceRate * laborInsuranceEmployeeShare;

                const healthBase = getHealthInsuranceBase(monthlySalary);
                const dependentsCount = parseInt(healthInsuranceDependentsInput.value) || 0;
                const totalInsurancePersons = 1 + Math.min(dependentsCount, 2); // æœ¬äºº1äºº + çœ·å±¬æœ€å¤š2äºº (3äººä»¥ä¸Šä»¥3äººè¨ˆ)
                healthInsuranceDeduction = healthBase * healthInsuranceRate * healthInsuranceEmployeeShare * totalInsurancePersons;
            }

            // Grand Total = Monthly Salary + Pure Overtime Pay + Lunch Subsidy + Overtime Meal Subsidy - Sick Leave Deduction - Personal Leave Deduction - Labor Insurance Deduction - Health Insurance Deduction
            const grandTotalPay = monthlySalary + pureOvertimePay + lunchSubsidy + totalOvertimeMealSubsidy - sickLeaveDeduction - personalLeaveDeduction - laborInsuranceDeduction - healthInsuranceDeduction;

            // Display Results
            displayMonthlySalary.textContent = monthlySalary.toLocaleString();
            displayHourlyWage.textContent = hourlyWage.toFixed(2);
            displayTotalOvertimeDays.textContent = actualOvertimeDaysCount;
            displayTotalOvertimeHours.textContent = totalOvertimeHours.toFixed(1);
            displayPureOvertimePay.textContent = pureOvertimePay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displayLunchSubsidy.textContent = lunchSubsidy.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displayOvertimeMealSubsidy.textContent = totalOvertimeMealSubsidy.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displaySickLeaveDeduction.textContent = sickLeaveDeduction.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displayPersonalLeaveDeduction.textContent = personalLeaveDeduction.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displayLaborInsuranceDeduction.textContent = laborInsuranceDeduction.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displayHealthInsuranceDeduction.textContent = healthInsuranceDeduction.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            displayGrandTotalPay.textContent = grandTotalPay.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            
            resultsArea.classList.remove('hidden'); // Show results area
            saveData(); // Save data after calculation
        }

        // Function: Clear all inputs and results, and clear localStorage
        function clearAll() {
            companyNameSelect.value = 'éå»£é”'; // Reset company name to default
            monthlySalaryInput.value = '';
            deductInsuranceCheckbox.checked = false;
            healthInsuranceDependentsInput.value = '0';
            dependentsInputGroup.classList.remove('active');
            totalWorkingDaysInput.value = '';
            overtimeDaysContainer.innerHTML = ''; 
            overtimeEntries = []; 
            leaveRecordsContainer.innerHTML = '';
            leaveEntries = [];
            salaryError.classList.add('hidden');
            workingDaysError.classList.add('hidden');
            resultsArea.classList.add('hidden');
            addOvertimeDayEntry(); 
            addLeaveDayEntry(); 
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            calcYearSelect.value = now.getFullYear();
            calcMonthSelect.value = now.getMonth() + 1;
            currentYear = now.getFullYear();
            currentMonth = now.getMonth() + 1;
            currentMonthDisplay.textContent = `${currentYear} å¹´ ${currentMonth} æœˆ`;
        }

        // Event Listeners
        addOvertimeDayBtn.addEventListener('click', addOvertimeDayEntry);
        addLeaveDayBtn.addEventListener('click', addLeaveDayEntry);
        calculateBtn.addEventListener('click', calculateOvertimeAndLeave);
        clearAllBtn.addEventListener('click', clearAll);

        // Toggle dependents input visibility based on checkbox
        deductInsuranceCheckbox.addEventListener('change', () => {
            if (deductInsuranceCheckbox.checked) {
                dependentsInputGroup.classList.add('active');
            } else {
                dependentsInputGroup.classList.remove('active');
            }
            saveData(); // Save checkbox state
        });

        // Add event listeners for main input fields to auto-save data
        companyNameSelect.addEventListener('change', saveData); // Save selected company name on change
        monthlySalaryInput.addEventListener('input', saveData);
        healthInsuranceDependentsInput.addEventListener('input', saveData);
        totalWorkingDaysInput.addEventListener('input', saveData);

        // Populate month/year selectors on load
        populateMonthYearSelectors(); 

        // Load data from localStorage on page load
        window.addEventListener('load', loadData);

    </script>
</body>
</html>
